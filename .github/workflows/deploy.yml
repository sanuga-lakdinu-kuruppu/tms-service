name: Deploy Lambda to AWS tms-service

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout code
        uses: actions/checkout@v2

      # 2Ô∏è‚É£ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "22"

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Package Lambda function
      - name: Package Lambda function
        run: zip -r function.zip .

      # 5Ô∏è‚É£ Verify zip file
      - name: Verify zip file
        run: ls -al function.zip

      # 6Ô∏è‚É£ Set deployment config (PROD only)
      - name: Set deployment config
        id: config
        run: |
          echo "function_name=tms-service" >> $GITHUB_OUTPUT
          echo "stage=PROD" >> $GITHUB_OUTPUT

      # 7Ô∏è‚É£ Configure AWS credentials
      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.ACCESSKEYID }}
          aws-secret-access-key: ${{ secrets.SECRETACCESSKEY }}
          aws-region: ${{ secrets.CURRENT_AWS_REGION }}

      # 8Ô∏è‚É£ Deploy to AWS Lambda
      - name: Deploy to AWS Lambda
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.config.outputs.function_name }} \
            --zip-file fileb://function.zip

      # 9Ô∏è‚É£ Wait for function update
      - name: Wait for function code update
        run: echo "Waiting for the function code update to complete..." && sleep 10

      # üîü Update Lambda environment variables
      - name: Update Lambda environment variables
        run: |
          aws lambda update-function-configuration \
            --function-name ${{ steps.config.outputs.function_name }} \
            --environment "Variables={ENVIRONMENT=\"${{ steps.config.outputs.stage }}\",CURRENT_AWS_REGION=\"${{ secrets.CURRENT_AWS_REGION }}\"}"

      # 1Ô∏è‚É£1Ô∏è‚É£ Clean up
      - name: Clean up
        run: rm function.zip
